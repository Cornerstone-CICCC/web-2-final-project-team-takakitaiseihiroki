---
/**
 * ContactForm Component
 */
import { Image } from 'astro:assets';
import contactFormImage from '../../assets/contact-form.jpg';

interface Props {
  tagline?: string;
  title?: string;
  description?: string;
  imageAlt?: string;
  services?: string[];
  termsUrl?: string;
  formspreeId: string;
}

const {
  tagline = 'Tagline',
  title = 'Contact us',
  description = 'Lorem ipsum dolor sit amet, consectetur adipiscing elit.',
  imageAlt = 'Car interior',
  services = [
    'Car Wash',
    'Oil Change',
    'Tire Service',
    'Engine Repair',
    'Body Work',
    'Other'
  ],
  termsUrl = '/terms',
  formspreeId
} = Astro.props;

const formAction = `https://formspree.io/f/${formspreeId}`;
---

<section class="contact-form-section">
  <div class="contact-form-section__container">
    <div class="contact-form-section__content">
      <div class="contact-form-section__text">
        <span class="contact-form-section__tagline">{tagline}</span>
        <h2 class="contact-form-section__title">{title}</h2>
        <p class="contact-form-section__description">{description}</p>
      </div>
      
      <form 
        id="contact-form"
        data-action={formAction}
        class="contact-form"
      >
        <div class="contact-form__row">
          <div class="contact-form__field">
            <label for="firstName" class="contact-form__label">First name</label>
            <input 
              type="text" 
              id="firstName" 
              name="firstName" 
              class="contact-form__input"
              required
              autocomplete="given-name"
            />
          </div>
          <div class="contact-form__field">
            <label for="lastName" class="contact-form__label">Last name</label>
            <input 
              type="text" 
              id="lastName" 
              name="lastName" 
              class="contact-form__input"
              required
              autocomplete="family-name"
            />
          </div>
        </div>
        
        <div class="contact-form__row">
          <div class="contact-form__field">
            <label for="phone" class="contact-form__label">Phone number</label>
            <input 
              type="tel" 
              id="phone" 
              name="phone" 
              class="contact-form__input"
              autocomplete="tel"
            />
          </div>
          <div class="contact-form__field">
            <label for="email" class="contact-form__label">Email</label>
            <input 
              type="email" 
              id="email" 
              name="email" 
              class="contact-form__input"
              required
              autocomplete="email"
            />
          </div>
        </div>
        
        <div class="contact-form__row">
          <div class="contact-form__field">
            <label for="service" class="contact-form__label">Select service</label>
            <div class="contact-form__select-wrapper">
              <select 
                id="service" 
                name="service" 
                class="contact-form__select"
                required
              >
                <option value="" disabled selected>Choose a service</option>
                {services.map((service) => (
                  <option value={service}>{service}</option>
                ))}
              </select>
              <svg class="contact-form__select-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m6 9 6 6 6-6"/>
              </svg>
            </div>
          </div>
          <div class="contact-form__field">
            <label for="appointmentDate" class="contact-form__label">Appointment date</label>
            <input 
              type="date" 
              id="appointmentDate" 
              name="appointmentDate" 
              class="contact-form__input contact-form__input--date"
            />
          </div>
        </div>
        
        <div class="contact-form__field contact-form__field--full">
          <label for="message" class="contact-form__label">Message</label>
          <textarea 
            id="message" 
            name="message" 
            class="contact-form__textarea"
            rows="5"
            placeholder="Type your message..."
          ></textarea>
        </div>
        
        <div class="contact-form__checkbox-wrapper">
          <input 
            type="checkbox" 
            id="acceptTerms" 
            name="acceptTerms" 
            class="contact-form__checkbox"
            required
          />
          <label for="acceptTerms" class="contact-form__checkbox-label">
            I accept the <a href={termsUrl} class="contact-form__link">Terms</a>
          </label>
        </div>
        
        <button type="submit" class="contact-form__submit">
          Submit
        </button>
        
        <div id="form-message" class="contact-form__message"></div>
      </form>
    </div>
    
    <div class="contact-form-section__image">
      <Image src={contactFormImage} alt={imageAlt} />
    </div>
  </div>
</section>

<script>
  const form = document.getElementById('contact-form') as HTMLFormElement;
  const submitButton = form?.querySelector('.contact-form__submit') as HTMLButtonElement;
  const messageDiv = document.getElementById('form-message');
  
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const action = form.dataset.action;
    if (!action) return;
    
    submitButton.disabled = true;
    submitButton.textContent = 'Sending...';
    
    const formData = new FormData(form);
    
    try {
      const response = await fetch(action, {
        method: 'POST',
        body: formData,
        headers: {
          'Accept': 'application/json'
        }
      });
      
      if (response.ok) {
        showMessage('Thank you! Your message has been sent.', 'success');
        form.reset();
      } else {
        showMessage('Something went wrong. Please try again.', 'error');
      }
    } catch {
      showMessage('Network error. Please try again.', 'error');
    } finally {
      submitButton.disabled = false;
      submitButton.textContent = 'Submit';
    }
  });
  
  function showMessage(text: string, type: 'success' | 'error') {
    if (messageDiv) {
      messageDiv.textContent = text;
      messageDiv.className = `contact-form__message contact-form__message--${type}`;
    }
  }
</script>

<style lang="scss">
  @use '../../styles/variables' as *;
  @use '../../styles/mixins' as *;

  .contact-form-section {
    padding: $spacing-xl 0;
    background-color: $color-background;
    width: 100vw;

    @include md {
      padding: $spacing-2xl 0;
    }

    &__container {
      @include container;
      display: grid;
      grid-template-columns: 1fr;
      gap: $spacing-2xl;

      @include lg {
        grid-template-columns: 1fr 1fr;
        gap: $spacing-4xl;
        align-items: stretch;
      }
    }

    &__content {
      @include flex-column;
      gap: $spacing-xl;
    }

    &__text {
      @include flex-column;
      gap: $spacing-sm;
    }

    &__tagline {
      font-size: $font-size-sm;
      font-weight: $font-weight-semibold;
      color: $color-primary;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    &__title {
      @include heading-2;
      margin: 0;
    }

    &__description {
      @include body-text;
      margin: 0;
    }

    &__image {
      display: none;
      overflow: hidden;

      @include lg {
        display: block;
        height: 100%;
      }

      img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
    }
  }

  .contact-form {
    @include flex-column;
    gap: $spacing-lg;

    &__row {
      display: grid;
      grid-template-columns: 1fr;
      gap: $spacing-lg;

      @include md {
        grid-template-columns: 1fr 1fr;
      }
    }

    &__field {
      @include flex-column;
      gap: $spacing-sm;

      &--full {
        grid-column: 1 / -1;
      }
    }

    &__label {
      @include label-text;
    }

    &__input,
    &__select,
    &__textarea {
      @include input-base;
    }

    &__input--date {
      cursor: pointer;

      &::-webkit-calendar-picker-indicator {
        cursor: pointer;
        opacity: 0.6;
        transition: opacity $transition-fast;

        &:hover {
          opacity: 1;
        }
      }
    }

    &__select-wrapper {
      position: relative;
    }

    &__select {
      appearance: none;
      padding-right: $spacing-2xl;
      cursor: pointer;
    }

    &__select-icon {
      position: absolute;
      right: $spacing-md;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: $color-secondary;
    }

    &__textarea {
      resize: vertical;
      min-height: 120px;
    }

    &__checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: $spacing-sm;
    }

    &__checkbox {
      width: 18px;
      height: 18px;
      accent-color: $color-primary;
      cursor: pointer;
    }

    &__checkbox-label {
      font-size: $font-size-sm;
      color: $color-primary;
    }

    &__link {
      @include link-underline;
    }

    &__submit {
      @include button-primary;
      width: 100%;

      @include md {
        width: auto;
        align-self: flex-start;
        padding: $spacing-sm $spacing-xl;
        font-size: $font-size-sm;
      }

      &:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }
    }

    &__message {
      padding: $spacing-md;
      border-radius: $border-radius-sm;
      font-size: $font-size-sm;
      text-align: center;

      &:empty {
        display: none;
      }

      &--success {
        background-color: #d4edda;
        color: #155724;
      }

      &--error {
        background-color: #f8d7da;
        color: #721c24;
      }
    }
  }
</style>