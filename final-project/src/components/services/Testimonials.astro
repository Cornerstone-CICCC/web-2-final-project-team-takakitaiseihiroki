---
const testimonials = [
  {
    src: "/services/icon1.png",
  },
  {
    src: "/services/icon2.png",
  },
  {
    src: "/services/icon3.png",
  },
  {
    src: "/services/icon1.png",
  },
  {
    src: "/services/icon2.png",
  },
  {
    src: "/services/icon3.png",
  },
  {
    src: "/services/icon1.png",
  },
];
---

<section class="testimonials" id="testimonials">
  <div class="inner">
    <h2>Customer testimonials</h2>
    <p class="lead">Check reviews from our clients</p>

    <div class="slider">
      <button class="nav prev" id="prevBtn" aria-label="Previous review"
        >←</button
      >

      <div class="viewport">
        <div class="track" id="testimonialTrack">
          {
            testimonials.map((item) => (
              <article class="card">
                <div class="card-top">
                  <div class="brand">webflow</div>
                </div>

                <p class="quote">
                  Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed
                  sit amet justo ipsum. Sed accumsan quam vitae est varius
                  fringilla.
                </p>

                <div class="footer">
                  <div class="person">
                    <img class="avatar" src={item.src} loading="lazy" />
                    <div>
                      <div class="name">Name Surname</div>
                      <div class="title">Position, Company name</div>
                    </div>
                  </div>
                  <div class="link">
                    <p>Read case study →</p>
                  </div>
                </div>
              </article>
            ))
          }
        </div>
      </div>

      <button class="nav next" id="nextBtn" aria-label="Next review">→</button>
    </div>

    <div class="dots" id="dots"></div>
  </div>
</section>

<script>
  const track = document.getElementById("testimonialTrack");
  const prev = document.getElementById("prevBtn");
  const next = document.getElementById("nextBtn");
  const dotsWrap = document.getElementById("dots");

  if (
    track instanceof HTMLElement &&
    prev instanceof HTMLElement &&
    next instanceof HTMLElement &&
    dotsWrap instanceof HTMLElement
  ) {
    const trackEl = track;
    const cards = Array.from(trackEl.children);
    let visible = window.innerWidth <= 640 ? 1 : 3;
    let index = 0;

    const updateVisible = () => {
      const newVisible = window.innerWidth <= 640 ? 1 : 3;
      if (newVisible !== visible) {
        visible = newVisible;
        index = Math.min(index, Math.max(cards.length - visible, 0));
        createDots();
        render();
      }
    };

    const createDots = () => {
      dotsWrap.innerHTML = "";
      const count = Math.max(cards.length - visible + 1, 1);
      for (let i = 0; i < count; i++) {
        const dot = document.createElement("button");
        dot.className = "dot";
        dot.type = "button";
        if (i === index) dot.classList.add("active");
        dot.addEventListener("click", () => {
          index = i;
          render();
        });
        dotsWrap.appendChild(dot);
      }
    };

    const render = () => {
      const cardWidth = cards[0]?.getBoundingClientRect().width || 0;
      const computedStyle = getComputedStyle(trackEl);
      const gap = parseFloat(computedStyle.columnGap || "0");
      const offset = (cardWidth + gap) * index;
      trackEl.style.transform = `translateX(-${offset}px)`;
      Array.from(dotsWrap.children).forEach((dot, i) => {
        dot.classList.toggle("active", i === index);
      });
    };

    const goPrev = () => {
      index = Math.max(index - 1, 0);
      render();
    };

    const goNext = () => {
      const maxIndex = Math.max(cards.length - visible, 0);
      index = Math.min(index + 1, maxIndex);
      render();
    };

    createDots();
    render();

    prev.addEventListener("click", goPrev);
    next.addEventListener("click", goNext);
    window.addEventListener("resize", () => {
      updateVisible();
      createDots();
      render();
    });
  }
</script>

<style>
  .testimonials {
    width: 100%;
    display: flex;
    justify-content: center;
    background: #f5f5f5;
    padding: 3rem 1rem 4rem;
  }

  .inner {
    width: min(1060px, 96%);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.85rem;
    text-align: center;
  }

  h2 {
    margin: 0;
    font-size: 1.4rem;
    font-weight: 700;
    color: #1f1f1f;
  }

  .lead {
    margin: 0 0 1rem;
    color: #5a5a5a;
    font-size: 0.9rem;
  }

  .slider {
    position: relative;
    width: 100%;
    padding: 0 2.4rem;
  }

  .viewport {
    overflow: hidden;
  }

  .track {
    display: grid;
    grid-auto-flow: column;
    grid-auto-columns: calc((100% - 2rem) / 3);
    column-gap: 1rem;
    transition: transform 200ms ease;
  }

  .card {
    background: #fff;
    border: 1px solid black;
    border-radius: 4px;
    padding: 1.05rem 1.05rem 1rem;
    min-height: 195px;
    text-align: left;
    display: flex;
    flex-direction: column;
    gap: 0.45rem;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
  }

  .card-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
  }

  .brand {
    font-weight: 700;
    font-size: 1.5rem;
    color: #111;
    margin-bottom: 2rem;
  }

  .rating {
    letter-spacing: 0.1rem;
    font-size: 0.88rem;
    color: #f6c14b;
  }

  .quote {
    margin: 0;
    color: #555;
    line-height: 1.5;
    font-size: 0.89rem;
  }

  .footer {
    margin-top: auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .person {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .avatar {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background: #f5f5f5;
    object-fit: cover;
    display: block;
  }

  .name {
    font-weight: 700;
    color: #222;
    line-height: 1.1;
  }

  .title {
    color: #666;
    font-size: 0.86rem;
    line-height: 1.1;
  }

  .link {
    font-size: 0.86rem;
    text-decoration: none;
    font-weight: 500;
  }

  .nav {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 1px solid #dcdcdc;
    background: #fff;
    cursor: pointer;
    display: grid;
    place-items: center;
    color: #333;
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.85rem;
  }

  .nav.prev {
    left: 0.2rem;
    transform: translateX(16px);
    z-index: 10;
  }

  .nav.next {
    right: 0.2rem;
    transform: translateX(-16px);
    z-index: 10;
  }

  .dots {
    display: flex;
    gap: 0.25rem;
    justify-content: center;
    margin-top: 0.9rem;
  }

  .dot {
    border-radius: 100%;
    border: none;
    background: #c2c2c2;
    cursor: pointer;
    padding: 0;
  }

  .dot.active {
    background: #111;
  }

  @media (max-width: 900px) {
    .inner {
      width: min(840px, 94%);
    }
  }

  @media (max-width: 640px) {
    .testimonials {
      padding: 2rem 1.1rem 3.5rem;
    }

    .slider {
      padding: 0;
    }

    .track {
      grid-auto-columns: 100%;
      column-gap: 0.85rem;
    }

    .nav {
      display: none;
    }

    .card {
      min-height: 195px;
    }
  }
</style>
